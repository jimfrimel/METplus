<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>METplus: /home/mccabe/metplus-doc/METplus/ush/produtil/dbnalert.py Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">METplus
   &#160;<span id="projectnumber">METplusV3.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_800bbfad623ff1c1bcbed02a018a6bda.html">ush</a></li><li class="navelem"><a class="el" href="dir_927812840bb05a9b23ea9540e8b05861.html">produtil</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">dbnalert.py</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno"><a class="line" href="namespaceprodutil_1_1dbnalert.html">    1</a></span>&#160;<span class="stringliteral">&quot;&quot;&quot;!This module runs the NCO dbn_alert program, or logs dbn_alert messages</span></div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="stringliteral">if run with dbn alerts disabled.&quot;&quot;&quot;</span></div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment">##@var __all__</span></div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="comment"># Symbols exported by &quot;from produtil.dbnalert import *&quot;</span></div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;__all__=[<span class="stringliteral">&quot;DBNAlert&quot;</span>]</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="keyword">import</span> logging, os</div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="keyword">import</span> <a class="code" href="namespaceprodutil_1_1run.html">produtil.run</a></div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;</div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="keyword">from</span> <a class="code" href="namespaceprodutil_1_1prog.html">produtil.prog</a> <span class="keyword">import</span> Runner</div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="keyword">from</span> <a class="code" href="namespaceprodutil_1_1run.html">produtil.run</a> <span class="keyword">import</span> checkrun, batchexe, alias, run</div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;</div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="comment"># Globals:</span></div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;</div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="comment">##@var log</span></div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="comment"># logging.Logger object to send dbnalert messages</span></div><div class="line"><a name="l00018"></a><span class="lineno"><a class="line" href="namespaceprodutil_1_1dbnalert.html#a5146063c64bc53cfcb0e6bc6a75f2bc2">   18</a></span>&#160;log=<span class="keywordtype">None</span></div><div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;</div><div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="comment">##@var job</span></div><div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="comment"># a string representing this job (from os.environ[&#39;job&#39;] by default)</span></div><div class="line"><a name="l00022"></a><span class="lineno"><a class="line" href="namespaceprodutil_1_1dbnalert.html#ad76e1e0ab49957e5c3e0dfd48261c427">   22</a></span>&#160;job=<span class="keywordtype">None</span></div><div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;</div><div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;<span class="comment">##@var send_dbn_alerts</span></div><div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;<span class="comment"># False = don&#39;t run dbn_alert.  Just log the alerts.</span></div><div class="line"><a name="l00026"></a><span class="lineno"><a class="line" href="namespaceprodutil_1_1dbnalert.html#aa04dad99fcc0eb6d9049aff0b111680a">   26</a></span>&#160;send_dbn_alerts=<span class="keyword">True</span></div><div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;</div><div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;<span class="comment">##@var no_DBNROOT_warn</span></div><div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;<span class="comment"># True = I have already warned that $DBNROOT is unset</span></div><div class="line"><a name="l00030"></a><span class="lineno"><a class="line" href="namespaceprodutil_1_1dbnalert.html#aa415f9b2acb38d35b0ea2c79959edf5d">   30</a></span>&#160;no_DBNROOT_warn=<span class="keyword">False</span></div><div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;</div><div class="line"><a name="l00032"></a><span class="lineno"><a class="line" href="namespaceprodutil_1_1dbnalert.html#a2a79f4e3e37e430037efdd3e1b97d1ee">   32</a></span>&#160;<span class="keyword">def </span><a class="code" href="namespaceprodutil_1_1dbnalert.html#a2a79f4e3e37e430037efdd3e1b97d1ee">find_dbn_alert</a>():</div><div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;    <span class="stringliteral">&quot;&quot;&quot;!Locates the dbn_alert executable based on environment</span></div><div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;<span class="stringliteral">    variables, and returns it as a produtil.prog.Runner object.&quot;&quot;&quot;</span></div><div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;    <span class="keyword">global</span> no_DBNROOT_warn</div><div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;    ENV=os.environ</div><div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;    <span class="keywordflow">if</span> ENV.get(<span class="stringliteral">&#39;DBNROOT&#39;</span>,<span class="stringliteral">&#39;&#39;</span>)!=<span class="stringliteral">&#39;&#39;</span>:</div><div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;        <span class="keywordflow">return</span> alias(batchexe(os.path.join(ENV[<span class="stringliteral">&#39;DBNROOT&#39;</span>],<span class="stringliteral">&#39;bin/dbn_alert&#39;</span>)))</div><div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;    <span class="keywordflow">else</span>:</div><div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;        <span class="keywordflow">if</span> <span class="keywordflow">not</span> no_DBNROOT_warn:</div><div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;            log.warning(<span class="stringliteral">&quot;$DBNROOT is not set.  Will search for dbn_alert &quot;</span></div><div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;                        <span class="stringliteral">&quot;in your $PATH.&quot;</span>)</div><div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;            no_DBNROOT_warn=<span class="keyword">True</span></div><div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;        <span class="keywordflow">return</span> alias(batchexe(<span class="stringliteral">&#39;dbn_alert&#39;</span>))</div><div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;</div><div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;<span class="comment">########################################################################</span></div><div class="line"><a name="l00047"></a><span class="lineno"><a class="line" href="classprodutil_1_1dbnalert_1_1DBNAlert.html">   47</a></span>&#160;<span class="keyword">class </span><a class="code" href="classprodutil_1_1dbnalert_1_1DBNAlert.html">DBNAlert</a>(object):</div><div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;    <span class="stringliteral">&quot;&quot;&quot;!This class represents a call to dbn_alert, as a callable Python</span></div><div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;<span class="stringliteral">    object.  It allows the instructions on how to make the call to be</span></div><div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;<span class="stringliteral">    stored for later use by a produtil.datastore.Product object&#39;s</span></div><div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;<span class="stringliteral">    add_callback and call_callbacks functions.&quot;&quot;&quot;</span></div><div class="line"><a name="l00052"></a><span class="lineno"><a class="line" href="classprodutil_1_1dbnalert_1_1DBNAlert.html#a1e8b58d8d41718acde9b82b8296e4a3d">   52</a></span>&#160;    <span class="keyword">def </span><a class="code" href="classprodutil_1_1dbnalert_1_1DBNAlert.html#a1e8b58d8d41718acde9b82b8296e4a3d">__init__</a>(self,args,loglevel=logging.WARNING,alert_exe=None):</div><div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;        <span class="stringliteral">&quot;&quot;&quot;!Create a new DBNAlert object that can be used to send an</span></div><div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;<span class="stringliteral">        alert later on.</span></div><div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;<span class="stringliteral">        @param args The arguments to dbn_alert.</span></div><div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;<span class="stringliteral">        @param alert_exe The dbn_alert executable name.</span></div><div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;<span class="stringliteral">        @param loglevel A Python logging level to log messages before each</span></div><div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;<span class="stringliteral">        alert.&quot;&quot;&quot;</span></div><div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;        <span class="keywordflow">if</span> <span class="keywordflow">not</span> isinstance(args,list) <span class="keywordflow">and</span> <span class="keywordflow">not</span> isinstance(args,tuple):</div><div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;            <span class="keywordflow">raise</span> TypeError(<span class="stringliteral">&#39;In DBNAlert(), the first argument must be a list or tuple of arguments to send to dbn_alert&#39;</span>)</div><div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;        <span class="keywordflow">if</span> alert_exe <span class="keywordflow">is</span> <span class="keywordflow">not</span> <span class="keywordtype">None</span> <span class="keywordflow">and</span> <span class="keywordflow">not</span> isinstance(alert_exe,str) \</div><div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;                <span class="keywordflow">and</span> <span class="keywordflow">not</span> isinstance(alert_exe,Runner):</div><div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;            <span class="keywordflow">raise</span> TypeError(<span class="stringliteral">&#39;In DBNAlert(), the alert_exe argument must be a string executable name, or a produtil.prog.Runner object&#39;</span>)</div><div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;</div><div class="line"><a name="l00065"></a><span class="lineno"><a class="line" href="classprodutil_1_1dbnalert_1_1DBNAlert.html#ace6032e59afcc6306867a0322ba6e8d3">   65</a></span>&#160;        self.<a class="code" href="classprodutil_1_1dbnalert_1_1DBNAlert.html#ace6032e59afcc6306867a0322ba6e8d3">alert_args</a>=[ str(s) <span class="keywordflow">for</span> s <span class="keywordflow">in</span> args ]</div><div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;        <span class="keywordflow">if</span> isinstance(alert_exe,Runner): alert_exe=alias(alert_exe)</div><div class="line"><a name="l00067"></a><span class="lineno"><a class="line" href="classprodutil_1_1dbnalert_1_1DBNAlert.html#adbafd6cbe3a967e7962217241878dae9">   67</a></span>&#160;        self.<a class="code" href="classprodutil_1_1dbnalert_1_1DBNAlert.html#adbafd6cbe3a967e7962217241878dae9">alert_exe</a>=alert_exe</div><div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;        <span class="keywordflow">if</span> self.<a class="code" href="classprodutil_1_1dbnalert_1_1DBNAlert.html#adbafd6cbe3a967e7962217241878dae9">alert_exe</a> <span class="keywordflow">is</span> <span class="keywordtype">None</span>: self.<a class="code" href="classprodutil_1_1dbnalert_1_1DBNAlert.html#adbafd6cbe3a967e7962217241878dae9">alert_exe</a>=<a class="code" href="namespaceprodutil_1_1dbnalert.html#a2a79f4e3e37e430037efdd3e1b97d1ee">find_dbn_alert</a>()</div><div class="line"><a name="l00069"></a><span class="lineno"><a class="line" href="classprodutil_1_1dbnalert_1_1DBNAlert.html#a336a1f153d453d08885768f370e0104d">   69</a></span>&#160;        self.<a class="code" href="classprodutil_1_1dbnalert_1_1DBNAlert.html#a336a1f153d453d08885768f370e0104d">loglevel</a>=loglevel</div><div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;    <span class="comment">##@var alert_args</span></div><div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;<span class="comment">    # Array of arguments to the alert function</span></div><div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;</div><div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;    <span class="comment">##@var loglevel</span></div><div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;<span class="comment">    # Desired logging level.</span></div><div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;</div><div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;    <span class="comment">##@var alert_exe</span></div><div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;<span class="comment">    # Alert executable</span></div><div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;</div><div class="line"><a name="l00079"></a><span class="lineno"><a class="line" href="classprodutil_1_1dbnalert_1_1DBNAlert.html#af1972608ef19219629b72a253a26725b">   79</a></span>&#160;    <span class="keyword">def </span><a class="code" href="classprodutil_1_1dbnalert_1_1DBNAlert.html#af1972608ef19219629b72a253a26725b">__call__</a>(self,**kwargs):</div><div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;        <span class="stringliteral">&quot;&quot;&quot;!Expands strings specified in the constructor and calls</span></div><div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;<span class="stringliteral">        dbn_alert with the results.  If dbn alerts are disabled, then</span></div><div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;<span class="stringliteral">        the fact that a dbn alert would be run is logged, but</span></div><div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;<span class="stringliteral">        dbn_alert is NOT called.</span></div><div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;<span class="stringliteral">        @param kwargs string formatting variables for the dbn alert arguments&quot;&quot;&quot;</span></div><div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;        assert(job <span class="keywordflow">is</span> <span class="keywordflow">not</span> <span class="keywordtype">None</span>)</div><div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;        kwargs[<span class="stringliteral">&#39;job&#39;</span>]=str(job)</div><div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;        alert_args=[ s.format(**kwargs) <span class="keywordflow">for</span> s <span class="keywordflow">in</span> self.<a class="code" href="classprodutil_1_1dbnalert_1_1DBNAlert.html#ace6032e59afcc6306867a0322ba6e8d3">alert_args</a> ]</div><div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;        <span class="keywordflow">if</span> send_dbn_alerts:</div><div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;            <span class="keywordflow">if</span> isinstance(self.<a class="code" href="classprodutil_1_1dbnalert_1_1DBNAlert.html#adbafd6cbe3a967e7962217241878dae9">alert_exe</a>,str):</div><div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;                cmd=batchexe(self.<a class="code" href="classprodutil_1_1dbnalert_1_1DBNAlert.html#adbafd6cbe3a967e7962217241878dae9">alert_exe</a>)[alert_args]</div><div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;            <span class="keywordflow">else</span>:</div><div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;                cmd=self.<a class="code" href="classprodutil_1_1dbnalert_1_1DBNAlert.html#adbafd6cbe3a967e7962217241878dae9">alert_exe</a>[alert_args]</div><div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;            log.log(logging.INFO,<span class="stringliteral">&#39;DBN Alert: &#39;</span>+repr(cmd))</div><div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;            ret=run(cmd)</div><div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;            exit_log_level=( logging.INFO <span class="keywordflow">if</span> ret==0 <span class="keywordflow">else</span> logging.ERROR )</div><div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;            log.log(exit_log_level,<span class="stringliteral">&#39;Exit status %s from dbn_alert.&#39;</span>%(repr(ret), ))</div><div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;        <span class="keywordflow">else</span>:</div><div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;            log.log(self.<a class="code" href="classprodutil_1_1dbnalert_1_1DBNAlert.html#a336a1f153d453d08885768f370e0104d">loglevel</a>,<span class="stringliteral">&#39;dbn_alert is disabled&#39;</span>)</div><div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;            log.log(self.<a class="code" href="classprodutil_1_1dbnalert_1_1DBNAlert.html#a336a1f153d453d08885768f370e0104d">loglevel</a>,<span class="stringliteral">&#39;would run: dbn_alert &#39;</span>+( <span class="stringliteral">&quot; &quot;</span>.join(alert_args) ))</div><div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;</div><div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;<span class="comment">########################################################################</span></div><div class="line"><a name="l00102"></a><span class="lineno"><a class="line" href="namespaceprodutil_1_1dbnalert.html#a26ed7d321563438228941955fc0d8f49">  102</a></span>&#160;<span class="keyword">def </span><a class="code" href="namespaceprodutil_1_1dbnalert.html#a26ed7d321563438228941955fc0d8f49">init_logging</a>(logger=None):</div><div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;    <span class="stringliteral">&quot;&quot;&quot;!Initializes logging for this module.  The argument is either a</span></div><div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;<span class="stringliteral">    logging.Logger to log to, or the string name of the logging</span></div><div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;<span class="stringliteral">    domain.&quot;&quot;&quot;</span></div><div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;    <span class="keyword">global</span> log</div><div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;    <span class="keywordflow">if</span> logger <span class="keywordflow">is</span> <span class="keywordtype">None</span>:</div><div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;        logger=logging.getLogger(<span class="stringliteral">&#39;dbn_alert&#39;</span>)</div><div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;    <span class="keywordflow">elif</span> isinstance(logger,str):</div><div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;        logger=logging.getLogger(logger)</div><div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;    log=logger</div><div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;</div><div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;<span class="comment">########################################################################</span></div><div class="line"><a name="l00114"></a><span class="lineno"><a class="line" href="namespaceprodutil_1_1dbnalert.html#a5ca33dee4c3e9317e620d64d89b1eb73">  114</a></span>&#160;<span class="keyword">def </span><a class="code" href="namespaceprodutil_1_1dbnalert.html#a5ca33dee4c3e9317e620d64d89b1eb73">init_jobstring</a>(jobname=None):</div><div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;    <span class="stringliteral">&quot;&quot;&quot;!Sets the job string (for dbn_alerts) to the specified value,</span></div><div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;<span class="stringliteral">    or if unspecified, tries to guess one from the environment.&quot;&quot;&quot;</span></div><div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;    <span class="keyword">global</span> job</div><div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;    <span class="keywordflow">if</span> jobname <span class="keywordflow">is</span> <span class="keywordflow">not</span> <span class="keywordtype">None</span>:</div><div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;        job=str(jobname)</div><div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;        <span class="keywordflow">return</span></div><div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;</div><div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;    ENV=os.environ</div><div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;    <span class="keywordflow">if</span> <span class="stringliteral">&#39;job&#39;</span> <span class="keywordflow">in</span> ENV:</div><div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;        job=str(ENV[<span class="stringliteral">&#39;job&#39;</span>])</div><div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;        <span class="keywordflow">return</span></div><div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;</div><div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;    <span class="comment"># Cannot guess a full name, so try to piece one together.  It will</span></div><div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;    <span class="comment"># look like &quot;LLMODEL_POST.30113&quot;</span></div><div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;    (name,iid)=(<span class="keywordtype">None</span>,<span class="keywordtype">None</span>) <span class="comment"># name=MODEL_POST part, iid=30113 part</span></div><div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;</div><div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;    <span class="comment"># Get the job name:</span></div><div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;    <span class="keywordflow">for</span> namevar <span class="keywordflow">in</span> [<span class="stringliteral">&#39;LSB_JOBNAME&#39;</span>,<span class="stringliteral">&#39;PBS_JOBNAME&#39;</span>,<span class="stringliteral">&#39;MOAB_JOBNAME&#39;</span>]:</div><div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;        <span class="keywordflow">if</span> namevar <span class="keywordflow">in</span> ENV <span class="keywordflow">and</span> ENV[namevar]!=<span class="stringliteral">&#39;&#39;</span>:</div><div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;            name=os.path.basename(ENV[namevar]) <span class="comment"># remove slashes</span></div><div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;            <span class="keywordflow">break</span></div><div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;    <span class="keywordflow">if</span> name <span class="keywordflow">is</span> <span class="keywordtype">None</span>: name=<span class="stringliteral">&#39;unknown&#39;</span></div><div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;</div><div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;    <span class="comment"># Get the job id:</span></div><div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;    <span class="keywordflow">for</span> iidvar <span class="keywordflow">in</span> [<span class="stringliteral">&#39;LSB_JOBID&#39;</span>,<span class="stringliteral">&#39;PBS_JOBID&#39;</span>,<span class="stringliteral">&#39;MOAB_JOBID&#39;</span>]:</div><div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;        <span class="keywordflow">if</span> iidvar <span class="keywordflow">in</span> ENV <span class="keywordflow">and</span> ENV[iidvar]!=<span class="stringliteral">&#39;&#39;</span>:</div><div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;            iid=str(ENV[iidvar])</div><div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;    <span class="keywordflow">if</span> iid <span class="keywordflow">is</span> <span class="keywordtype">None</span>: iid=str(os.getpid())</div><div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;</div><div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;    job=<span class="stringliteral">&#39;LL%s.%s&#39;</span>%(name,iid)</div><div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;</div><div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;<span class="comment">########################################################################</span></div><div class="line"><a name="l00147"></a><span class="lineno"><a class="line" href="namespaceprodutil_1_1dbnalert.html#a73f078ebebc62083017bbfd6409d3f7d">  147</a></span>&#160;<span class="keyword">def </span><a class="code" href="namespaceprodutil_1_1dbnalert.html#a73f078ebebc62083017bbfd6409d3f7d">init_dbn_alert</a>(send_dbn=None):</div><div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;    <span class="stringliteral">&quot;&quot;&quot;!DBN alert initialization helper function.</span></div><div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;<span class="stringliteral">    This is part of the implementation of init_module: it decides</span></div><div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;<span class="stringliteral">    whether to send DBNet alerts, and sets the module-scope</span></div><div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;<span class="stringliteral">    send_dbn_alerts variable accordingly.  That will then be used by</span></div><div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;<span class="stringliteral">    DBNAlert objects to decide whether to actually call the dbn_alert</span></div><div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;<span class="stringliteral">    program.</span></div><div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;<span class="stringliteral">    @protected</span></div><div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;<span class="stringliteral">    @param send_dbn Do we send dbn alerts?&quot;&quot;&quot;</span></div><div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;    logger=logging.getLogger(<span class="stringliteral">&#39;dbn_alert&#39;</span>)</div><div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;    <span class="keyword">global</span> send_dbn_alerts</div><div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;    ENV=os.environ</div><div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;    send_dbn_alerts=<span class="keyword">False</span></div><div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;</div><div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;    <span class="keywordflow">if</span> send_dbn <span class="keywordflow">is</span> <span class="keywordflow">not</span> <span class="keywordtype">None</span> <span class="keywordflow">and</span> <span class="keywordflow">not</span> send_dbn:</div><div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;        send_dbn_alerts=send_dbn</div><div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;        <span class="keywordflow">return</span></div><div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;</div><div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;    <span class="keywordflow">if</span> <span class="stringliteral">&#39;RUN_ENVIR&#39;</span> <span class="keywordflow">not</span> <span class="keywordflow">in</span> ENV:</div><div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;        logger.warning(<span class="stringliteral">&#39;RUN_ENVIR is unset.  Disabling DBN alerts.&#39;</span>)</div><div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;    <span class="keywordflow">elif</span> ENV[<span class="stringliteral">&#39;RUN_ENVIR&#39;</span>].upper()!=<span class="stringliteral">&#39;NCO&#39;</span>:</div><div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;        logger.info(<span class="stringliteral">&#39;RUN_ENVIR=%s is not &quot;NCO&quot;.  Disabling DBN alerts.&#39;</span></div><div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;                       %(ENV[<span class="stringliteral">&#39;RUN_ENVIR&#39;</span>],))</div><div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;    <span class="keywordflow">elif</span> send_dbn <span class="keywordflow">is</span> <span class="keywordtype">None</span>:</div><div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;        send_dbn_alerts = ( <span class="stringliteral">&#39;YES&#39;</span> == ENV.get(<span class="stringliteral">&#39;SENDDBN&#39;</span>,<span class="stringliteral">&#39;NO&#39;</span>).upper() )</div><div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;        <span class="keywordflow">if</span> send_dbn_alerts:</div><div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;            logger.info(<span class="stringliteral">&#39;Enabling dbn_alerts because SENDDBN=YES&#39;</span>)</div><div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;        <span class="keywordflow">else</span>:</div><div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;            logger.info(<span class="stringliteral">&#39;Disabling dbn_alerts because SENDDBN is not YES&#39;</span>)</div><div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;    <span class="keywordflow">else</span>:</div><div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;        send_dbn_alerts=send_dbn</div><div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;        <span class="keywordflow">if</span> send_dbn_alerts:</div><div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;            logger.info(<span class="stringliteral">&#39;Enabling dbn_alerts because the code manually &#39;</span></div><div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;                           <span class="stringliteral">&#39;turned them on (send_dbn=True)&#39;</span>)</div><div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;        <span class="keywordflow">else</span>:</div><div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;            logger.info(<span class="stringliteral">&#39;Disabling dbn_alerts because the code manually &#39;</span></div><div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;                           <span class="stringliteral">&#39;turned them off (send_dbn=False)&#39;</span>)</div><div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;    <span class="keywordflow">if</span> <span class="stringliteral">&#39;DBNROOT&#39;</span> <span class="keywordflow">not</span> <span class="keywordflow">in</span> ENV:</div><div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;        logger.warning(<span class="stringliteral">&#39;DBNROOT is unset.  Disabling DBN alerts.&#39;</span>)</div><div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;        send_dbn_alerts=<span class="keyword">False</span></div><div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;    <span class="keywordflow">elif</span> ENV.get(<span class="stringliteral">&#39;DBNROOT&#39;</span>) == <span class="stringliteral">&#39;DBNROOT_OFF&#39;</span>:</div><div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;        logger.info(</div><div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;            <span class="stringliteral">&#39;DBNROOT is set to DBNROOT_OFF.  Disabling DBN alerts.&#39;</span>)</div><div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;        send_dbn_alerts=<span class="keyword">False</span></div><div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;</div><div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;<span class="comment">########################################################################</span></div><div class="line"><a name="l00194"></a><span class="lineno"><a class="line" href="namespaceprodutil_1_1dbnalert.html#a583109c8f75046d299a2b5477ac8d69f">  194</a></span>&#160;<span class="keyword">def </span><a class="code" href="namespaceprodutil_1_1dbnalert.html#a583109c8f75046d299a2b5477ac8d69f">init_module</a>(logger=None,jobname=None,send_dbn=None):</div><div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;    <span class="stringliteral">&quot;&quot;&quot;!Call to initialize this module.</span></div><div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;<span class="stringliteral">    Initializes the logging and job string for this module.</span></div><div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;<span class="stringliteral">    @param logger Either a logging.Logger object to receive log</span></div><div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;<span class="stringliteral">      messages, or the string name of a logger domain.</span></div><div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;<span class="stringliteral">    @param jobname The dbn_alert job string for this job.</span></div><div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;<span class="stringliteral">    @param send_dbn Optional.  If specified, this controls whether</span></div><div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;<span class="stringliteral">      dbn_alert is actually run (True) or not (False).  If unspecified,</span></div><div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;<span class="stringliteral">      then the SENDDBN environment variable is used.&quot;&quot;&quot;</span></div><div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;    <a class="code" href="namespaceprodutil_1_1dbnalert.html#a5ca33dee4c3e9317e620d64d89b1eb73">init_jobstring</a>(jobname)</div><div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;    <a class="code" href="namespaceprodutil_1_1dbnalert.html#a26ed7d321563438228941955fc0d8f49">init_logging</a>(logger)</div><div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;    <a class="code" href="namespaceprodutil_1_1dbnalert.html#a73f078ebebc62083017bbfd6409d3f7d">init_dbn_alert</a>(send_dbn)</div><div class="ttc" id="namespaceprodutil_1_1dbnalert_html_a73f078ebebc62083017bbfd6409d3f7d"><div class="ttname"><a href="namespaceprodutil_1_1dbnalert.html#a73f078ebebc62083017bbfd6409d3f7d">produtil.dbnalert.init_dbn_alert</a></div><div class="ttdeci">def init_dbn_alert(send_dbn=None)</div><div class="ttdoc">DBN alert initialization helper function. </div><div class="ttdef"><b>Definition:</b> <a href="dbnalert_8py_source.html#l00147">dbnalert.py:147</a></div></div>
<div class="ttc" id="namespaceprodutil_1_1dbnalert_html_a583109c8f75046d299a2b5477ac8d69f"><div class="ttname"><a href="namespaceprodutil_1_1dbnalert.html#a583109c8f75046d299a2b5477ac8d69f">produtil.dbnalert.init_module</a></div><div class="ttdeci">def init_module(logger=None, jobname=None, send_dbn=None)</div><div class="ttdoc">Call to initialize this module. </div><div class="ttdef"><b>Definition:</b> <a href="dbnalert_8py_source.html#l00194">dbnalert.py:194</a></div></div>
<div class="ttc" id="namespaceprodutil_1_1dbnalert_html_a2a79f4e3e37e430037efdd3e1b97d1ee"><div class="ttname"><a href="namespaceprodutil_1_1dbnalert.html#a2a79f4e3e37e430037efdd3e1b97d1ee">produtil.dbnalert.find_dbn_alert</a></div><div class="ttdeci">def find_dbn_alert()</div><div class="ttdoc">Locates the dbn_alert executable based on environment variables, and returns it as a produtil...</div><div class="ttdef"><b>Definition:</b> <a href="dbnalert_8py_source.html#l00032">dbnalert.py:32</a></div></div>
<div class="ttc" id="classprodutil_1_1dbnalert_1_1DBNAlert_html_a336a1f153d453d08885768f370e0104d"><div class="ttname"><a href="classprodutil_1_1dbnalert_1_1DBNAlert.html#a336a1f153d453d08885768f370e0104d">produtil.dbnalert.DBNAlert.loglevel</a></div><div class="ttdeci">loglevel</div><div class="ttdoc">Desired logging level. </div><div class="ttdef"><b>Definition:</b> <a href="dbnalert_8py_source.html#l00069">dbnalert.py:69</a></div></div>
<div class="ttc" id="classprodutil_1_1dbnalert_1_1DBNAlert_html_ace6032e59afcc6306867a0322ba6e8d3"><div class="ttname"><a href="classprodutil_1_1dbnalert_1_1DBNAlert.html#ace6032e59afcc6306867a0322ba6e8d3">produtil.dbnalert.DBNAlert.alert_args</a></div><div class="ttdeci">alert_args</div><div class="ttdoc">Array of arguments to the alert function. </div><div class="ttdef"><b>Definition:</b> <a href="dbnalert_8py_source.html#l00065">dbnalert.py:65</a></div></div>
<div class="ttc" id="namespaceprodutil_1_1prog_html"><div class="ttname"><a href="namespaceprodutil_1_1prog.html">produtil.prog</a></div><div class="ttdoc">Implements the produtil.run: provides the object tree for representing shell commands. </div><div class="ttdef"><b>Definition:</b> <a href="prog_8py_source.html#l00001">prog.py:1</a></div></div>
<div class="ttc" id="namespaceprodutil_1_1run_html"><div class="ttname"><a href="namespaceprodutil_1_1run.html">produtil.run</a></div><div class="ttdoc">A shell-like syntax for running serial, MPI and OpenMP programs. </div><div class="ttdef"><b>Definition:</b> <a href="run_8py_source.html#l00001">run.py:1</a></div></div>
<div class="ttc" id="namespaceprodutil_1_1dbnalert_html_a5ca33dee4c3e9317e620d64d89b1eb73"><div class="ttname"><a href="namespaceprodutil_1_1dbnalert.html#a5ca33dee4c3e9317e620d64d89b1eb73">produtil.dbnalert.init_jobstring</a></div><div class="ttdeci">def init_jobstring(jobname=None)</div><div class="ttdoc">Sets the job string (for dbn_alerts) to the specified value, or if unspecified, tries to guess one fr...</div><div class="ttdef"><b>Definition:</b> <a href="dbnalert_8py_source.html#l00114">dbnalert.py:114</a></div></div>
<div class="ttc" id="namespaceprodutil_1_1dbnalert_html_a26ed7d321563438228941955fc0d8f49"><div class="ttname"><a href="namespaceprodutil_1_1dbnalert.html#a26ed7d321563438228941955fc0d8f49">produtil.dbnalert.init_logging</a></div><div class="ttdeci">def init_logging(logger=None)</div><div class="ttdoc">Initializes logging for this module. </div><div class="ttdef"><b>Definition:</b> <a href="dbnalert_8py_source.html#l00102">dbnalert.py:102</a></div></div>
<div class="ttc" id="classprodutil_1_1dbnalert_1_1DBNAlert_html"><div class="ttname"><a href="classprodutil_1_1dbnalert_1_1DBNAlert.html">produtil.dbnalert.DBNAlert</a></div><div class="ttdoc">This class represents a call to dbn_alert, as a callable Python object. </div><div class="ttdef"><b>Definition:</b> <a href="dbnalert_8py_source.html#l00047">dbnalert.py:47</a></div></div>
<div class="ttc" id="classprodutil_1_1dbnalert_1_1DBNAlert_html_a1e8b58d8d41718acde9b82b8296e4a3d"><div class="ttname"><a href="classprodutil_1_1dbnalert_1_1DBNAlert.html#a1e8b58d8d41718acde9b82b8296e4a3d">produtil.dbnalert.DBNAlert.__init__</a></div><div class="ttdeci">def __init__(self, args, loglevel=logging.WARNING, alert_exe=None)</div><div class="ttdoc">Create a new DBNAlert object that can be used to send an alert later on. </div><div class="ttdef"><b>Definition:</b> <a href="dbnalert_8py_source.html#l00052">dbnalert.py:52</a></div></div>
<div class="ttc" id="classprodutil_1_1dbnalert_1_1DBNAlert_html_af1972608ef19219629b72a253a26725b"><div class="ttname"><a href="classprodutil_1_1dbnalert_1_1DBNAlert.html#af1972608ef19219629b72a253a26725b">produtil.dbnalert.DBNAlert.__call__</a></div><div class="ttdeci">def __call__(self, kwargs)</div><div class="ttdoc">Expands strings specified in the constructor and calls dbn_alert with the results. </div><div class="ttdef"><b>Definition:</b> <a href="dbnalert_8py_source.html#l00079">dbnalert.py:79</a></div></div>
<div class="ttc" id="classprodutil_1_1dbnalert_1_1DBNAlert_html_adbafd6cbe3a967e7962217241878dae9"><div class="ttname"><a href="classprodutil_1_1dbnalert_1_1DBNAlert.html#adbafd6cbe3a967e7962217241878dae9">produtil.dbnalert.DBNAlert.alert_exe</a></div><div class="ttdeci">alert_exe</div><div class="ttdoc">Alert executable. </div><div class="ttdef"><b>Definition:</b> <a href="dbnalert_8py_source.html#l00067">dbnalert.py:67</a></div></div>
</div><!-- fragment --></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
